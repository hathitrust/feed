version: '3'

services:

  ingest:
    build: .
    volumes:
      - .:/usr/local/feed
      - ./ingest_stage:/tmp/stage
      - repository_link:/sdr1
      - repository_obj:/sdr2
      - backups:/htdataden
    environment:
      - HTFEED_CONFIG=/usr/local/feed/etc/config_ingest.yml
      - FEED_HOME=/usr/local/feed

  test:
    build: .
    volumes:
      - .:/usr/local/feed
    environment:
      - HTFEED_CONFIG=/usr/local/feed/etc/config_test.yml
      - FEED_HOME=/usr/local/feed
      - TEST=1

  travis_test:
    build: .
    environment:
      - HTFEED_CONFIG=/usr/local/feed/etc/config_test.yml
      - FEED_HOME=/usr/local/feed
      - TEST=1
    command: bin/wait-for --timeout=300 mariadb:3306 -- make test TEST_VERBOSE=1

  validate:
    build: .
    volumes:
      - .:/usr/local/feed
      - ./volumes_to_test:/tmp/stage/toingest/test
    environment:
      - HTFEED_CONFIG=/usr/local/feed/etc/config_prevalidate.yml
      - FEED_HOME=/usr/local/feed
    command: bash -c "/bin/ls /tmp/stage/toingest/test/*.zip | xargs -n 1 basename | sed s/.zip// | perl -w /usr/local/feed/bin/validate_volume.pl -p simple -n test --no-clean"

  mariadb:
    build: docker/database
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: mysqlroot

      # TODO: handle server??

volumes:
  repository_link:
  repository_obj:
  backups:
